

<!DOCTYPE html>
<html lang="ko-KR" data-default-color-scheme="&#34;auto&#34;">



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="hack &amp; life">
  <meta name="author" content="j0dev, y2sman">
  <meta name="keywords" content>
  <meta name="google-site-verification" content="DXkyiaX95-ws53Tyt0m91_umRf4gfV2qJIQZ5zQDIO4">

  <meta property="og:type" content="website"> 
  <meta property="og:title" content="[Translation] Exploiting System Mechanic Driver Part 1 - hackyboiz">
  <meta property="og:description" content="hack &amp; life">
  <meta property="og:image" content="/img/favicon.ico">
  <meta property="og:url" content="https://hackyboiz.github.io/">

  <link rel="canonical" href="https://hackyboiz.github.io/2021/04/21/l0ch/exploiting-driver/">

  <title>[Translation] Exploiting System Mechanic Driver Part 1 - hackyboiz</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css">
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">
<link rel="stylesheet" href="/.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">
<link rel="stylesheet" href="/.css">


<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>

<meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/rss2.xml" title="hackyboiz" type="application/rss+xml">
</head>

<body>
  <header style="height: 40vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>Hackyboiz</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-addrcard"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/author/">
                <i class="iconfont icon-user-fill"></i>
                Author
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax="true" style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2021-04-21 14:00" pubdate>
      2021년 4월 21일 오후
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      1.4k 자
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      27
       분
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2">
      <script data-ad-client="ca-pub-3672652207808168" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">[Translation] Exploiting System Mechanic Driver Part 1</h1>
            
            <div class="markdown-body" id="post-body">
              <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
              <!-- hackyboiz_horizen_index -->
              <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3672652207808168" data-ad-slot="8887862313" data-ad-format="auto" data-full-width-responsive="true"></ins>
              <script>
                   (adsbygoogle = window.adsbygoogle || []).push({});
              </script>
              <h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>중간고사 망한 L0ch입니다. 아직 3과목이나 남았지만 눈에 띄는 글이 있어 망한 김에 시험공부는 던지고 번역해봤습니다. 인생..  </p>
<blockquote>
<p>교수님 이제 그만 절 놓아주세요..</p>
</blockquote>
<p>커널 드라이버 취약점에 대해 알기 쉽게 정리한 글이 있어서 파트 2로 나눠서 정리해봤습니다. 파트 1에서는 드라이버 구조에 대한 소개와 IOCTL, 드라이버 퍼징에 대한 내용을 다루며 파트 2에서는 본격적인 드라이버 취약점의 root cause 분석과 익스플로잇에 대해 다룹니다!  </p>
<blockquote>
<p>원문 글 : <a target="_blank" rel="external nofollow noopener noreferrer" href="https://labs.yarix.com/2021/04/exploiting-system-mechanic-driver/">Exploiting System Mechanic Driver</a></p>
</blockquote>
<hr>
<p>지난달 last&amp;VoidSec은 NULLCON에서 Ashfaq Ansari(@HackSysTeam)의 Windows Kernel Exploitation Advanced 과정을 수강했다. 이 과정은 흥미로웠으며 core kernel 공간의 개념과 mitigation 우회 및 exploit에 대해 다루었다. 마지막 실습인 <code>Write an exploit for System Mechanics</code> 에서는 더 이상의 힌트는 제공되지 않았으며 우리는 새로 습득한 지식과 교육 자료에 대한 이해와 리버스 엔지니어링을 테스트하기 위해 도전했다. 이 실습을 어떻게 수행했는지, 그리고 사전 지식 없이 실제 드라이버를 어떻게 활용했는지에 대해 자세히 알아보도록 한다.</p>
<h1 id="Windows-drivers-101"><a href="#Windows-drivers-101" class="headerlink" title="Windows drivers 101"></a>Windows drivers 101</h1><p>드라이버를 리버스 엔지니어링하고 취약점을 찾기 전에 먼저 드라이버가 무엇이며 어떻게 작동하는지 살펴봐야 한다. Windows에서 드라이버는 기본적으로 특정 이벤트가 발생할 때 커널 컨텍스트에서 실행되는 코드를 포함하는 로드 가능한 모듈로 정의할 수 있다. 이벤트는 운영체제가 수행하는 인터럽트 또는 프로세스일 수 있으면 커널은 이러한 인터럽트를 처리하고 요청을 수행하기 위해 적절한 드라이버를 실행한다. 따라서 드라이버 = 커널의 DLL이라고 생각할 수 있다. 드라이버는 프로세스 탐색기에서 시스템 프로세스(PID 4가 있는 모듈) 내에서 로드된 모듈로 나열된다.</p>
<p><img src="/2021/04/21/l0ch/exploiting-driver/Untitled.png" srcset="/img/loading.gif" alt="exploiting-driver/Untitled.png"></p>
<blockquote>
<p>PID 4(System Process)에 로드된 모듈</p>
</blockquote>
<h2 id="Driver-Entry"><a href="#Driver-Entry" class="headerlink" title="Driver Entry"></a>Driver Entry</h2><p>이제 드라이버의 구조를 살펴보겠다. 대부분의 코드와 마찬가지로 드라이버에는 <code>DriverEntry</code>라는 일종의 <code>main</code> 함수가 존재한다. 이 기능은 다음과 같이 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/driverentry-for-kmdf-drivers">Microsoft 문서</a>에 정의되어 있다.</p>
<pre><code class="hljs cpp"><span class="hljs-function">NTSTATUS <span class="hljs-title">DriverEntry</span> <span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">  _In_ PDRIVER_OBJECT DriverObject,</span></span>
<span class="hljs-function"><span class="hljs-params">  _In_ PUNICODE_STRING RegistryPath</span></span>
<span class="hljs-function"><span class="hljs-params">)</span> </span>;</code></pre>

<p>인수 앞의 <code>_In_</code> 은 인수가 <code>DriverEntry</code> 함수에 전달되는 입력값이어야 한다는 의미이다. <code>DriverObject</code> 인수는 드라이버에 대한 정보를 보유하는 <code>DRIVER_OBJECT</code> 데이터 구조에 대한 포인터를 나타내며 이후에 더 자세히 설명하도록 하겠다. <code>RegistryPath</code> 인수는 드라이버 이미지(커널이 드라이버 코드를 로드하는 <code>.sys</code> 파일)의 레지스트리 경로를 포함하는 <code>UNICODE_STRING</code> 구조체 (UTF-16 문자열 및 기타 제어정보를 포함하는 구조체)에 대한 포인터이다.</p>
<h2 id="Devices-amp-Symlinks"><a href="#Devices-amp-Symlinks" class="headerlink" title="Devices &amp; Symlinks"></a>Devices &amp; Symlinks</h2><p>유저 모드에서 액세스 하려면 드라이버가 표준 유저 프로세스에 액세스할 수 있도록 장치와 심볼릭 링크(a.k.a symlink)를 만들어야 한다. 장치는 프로세스가 드라이버와 상호작용 할 수 있도록 하는 인터페이스이며 심볼릭 링크는 <code>Win32</code>함수를 호출하는 동안 사용할 수 있는 장치 이름(alias-별칭)이다.</p>
<p>심볼릭 링크의 예:  <code>C:\</code>는 저장장치를 위한 심볼릭 링크에 불과하다. <code>Sysinternals</code>의 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/sysinternals/downloads/winobj">WinObj</a> 툴을 사용해 root namespace 아래의 <code>GLOBAL??</code>  디렉터리에서 <code>C:</code>를 찾을 수 있다.  </p>
<p><img src="/2021/04/21/l0ch/exploiting-driver/Untitled%201.png" srcset="/img/loading.gif" alt="exploiting-driver/Untitled%201.png"></p>
<p>드라이버는 <code>IoCreateDevice</code> 및 <code>IoCreateSymbolicLink</code>를 사용하여 장치 및 심볼릭 링크를 만든다. 드라이버를 리버스 엔지니어링 할 때 위 두 함수가 연속적으로 호출이 장치와 심볼릭 링크를 인스턴스화 하는 부분인 것을 확인할 수 있다. 대부분의 드라이버는 하나의 장치만 사용하므로 대부분 한 번만 발생하며 일반적으로 장치 이름은 <code>\Device\VulnerableDevice</code> 형식을 사용한다. 반면 심볼릭 링크는 <code>\\.\VulnerableDeviceSymlink</code> 형식과 유사하다. 이제 드라이버의 “frontend”에 대해 설명했으므로 “backend”인 디스패치 루틴에 대해 설명하겠다.</p>
<h2 id="Dispatch-Routines"><a href="#Dispatch-Routines" class="headerlink" title="Dispatch Routines"></a>Dispatch Routines</h2><p>드라이버는 장치에서 호출되는 함수에 따라 다른 작업(a.k.a 함수/루틴)을 실행한다. 드라이버는 <code>WriteFile</code>, <code>ReadFile</code> 또는 <code>DeviceIoControl</code> API가 해당 장치에서 호출될 때 각각 다르게 작동할 수 있다. 이 동작은 <code>DriverObject</code>구조체의 함수 포인터 배열인 <code>MajorFunctions</code>멤버를 통해 드라이버 개발자가 제어한다. <code>WriteFile</code>, <code>ReadFile</code> 또는 <code>DeviceIoControl</code>과 같은 API는 <code>MajorFunctions</code> 내에 해당 인덱스가 있어 관련 함수 포인터가 호출된다. 일부 매크로를 사용하여 관련 인덱스를 기억할 수 있으며 다음은 몇 가지 예다.</p>
<ul>
<li><code>IRP_MJ_CREATE</code> : <code>CreateFile</code> 호출 후 호출되는 함수 포인터를 포함하는 인덱스</li>
<li><code>IRP_MJ_READ</code> : <code>ReadFile</code>과 같은 함수와 관련된 인덱스</li>
<li><code>IRP_MJ_DEVICE_CONTROL</code> : DeviceIoControl에 해당하는 인덱스</li>
</ul>
<p>드라이버 개발자가 <code>MyDriverRead</code> 라는 함수를 정의했으며 프로세스가 드라이버 장치에서 <code>ReadFile</code> API를 호출할 때 호출되기를 원한다고 가정해본다. <code>DriverEntry</code> 내부 (또는 호출된 함수)에 다음 코드를 작성하면 된다.</p>
<pre><code class="hljs cpp">DriverObject-&gt;MajorFunctions[IRP_MJ_READ] = MyDriverRead;</code></pre>

<p>이와 같은 함수는 디스패치 루틴의 이름을 사용한다. 그러나 <code>MajorFunctions</code>는 제한된 크기의 배열이므로 드라이버에 많은 디스패치 루틴을 할당하지 못한다. 이 문제점은 유저 모드 함수 <code>DeviceIoControl</code> 를 사용하는 이유가 된다.</p>
<h2 id="DEVICEIOCONTROL-amp-IOCTL-Codes"><a href="#DEVICEIOCONTROL-amp-IOCTL-Codes" class="headerlink" title="DEVICEIOCONTROL &amp; IOCTL Codes"></a>DEVICEIOCONTROL &amp; IOCTL Codes</h2><p><code>IRP_MJ_DEVICE_CONTROL</code>로 정의된 <code>MajorFunctions</code> 내에는 특정 인덱스가 있다. 이 인덱스에는 드라이버 장치에서 <code>DeviceIoControl</code> API 호출 후 호출되는 디스패치 루틴의 함수 포인터가 저장된다. 이 함수는 인수 중 하나가 IOCTL로 알려진 32 비트 정수이기 때문에 매우 중요하다. 이 I/O 코드는 드라이버에 전달되고 <code>DeviceIoControl</code>을 통해 전달되는 IOCTL에 따라 각각의 작업을 수행한다. 인덱스 <code>IRP_MJ_DEVICE_CONTROL</code>의 디스패치 루틴은 코드의 다음과 같은 스위치 케이스처럼 작동한다.</p>
<pre><code class="hljs cpp"><span class="hljs-keyword">switch</span>(IOCTL)
&#123;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xDEADBEEF</span>:
        DoThis();
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xC0FFEE</span>;
        DoThat();
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0x600DBABE</span>;
    DoElse();
    <span class="hljs-keyword">break</span>;
&#125;</code></pre>

<p>이러한 방식으로 개발자는 프로세스에서 전송하는 IOCTL 코드에 따라 드라이버가 함수를 호출하도록 할 수 있다. 이러한 종류의 “코드 지문”은 드라이버를 리버스 엔지니어링 하는 동안 찾기가 매우 쉽기 때문에 매우 중요하다. 어떤 IOCTL이 어떤 코드로 연결되는지 알면 드라이버를 더 쉽게 분석하고 퍼징할 수 있다.</p>
<h1 id="Reverse-Engineering-Finding-the-IOCTL"><a href="#Reverse-Engineering-Finding-the-IOCTL" class="headerlink" title="Reverse Engineering: Finding the IOCTL"></a>Reverse Engineering: Finding the IOCTL</h1><p>드라이버 리버스 엔지니어링을 시작하기 전에 첫 번째로 해야 할 일은 통신에 사용하는 IOCTL 코드와 장치 이름 (symlink)을 찾는 것이다. 우리의 경우 대상 애플리케이션은 <code>iolo – System Mechanic Pro v.15.5.0.61 (amp.sys)</code>이며 설치 시 <code>WinObj</code>를 활용하여 다음과 같이 장치 이름과 권한을 복구했다.</p>
<p><img src="/2021/04/21/l0ch/exploiting-driver/Untitled%202.png" srcset="/img/loading.gif" alt="exploiting-driver/Untitled%202.png"></p>
<p>이제 장치 이름 <code>\Device\AMP</code>을 수집했으니 드라이버 <code>amp.sys</code>를 디스어셈블러 (IDA 사용)에 로드하고 누락된 경우 다음과 같은 필요한 구조체를 추가한다.</p>
<ul>
<li><code>DRIVER_OBJECT</code></li>
<li><code>IRP</code></li>
<li><code>IO_STACK_LOCATION</code></li>
</ul>
<p><code>DriverEntry</code> 함수에 도달하면 드라이버가 생각보다 조금 더 복잡하다는 것을 알 수 있다. <code>Imports</code> 섹션에서 <code>IoDeviceControl</code> API를 xref하기로 결정했으며 그 결과는 <code>SUB_2CFE0</code>(<code>DriverCreateDevice</code>로 변경) 하나뿐이다. </p>
<p><img src="/2021/04/21/l0ch/exploiting-driver/Untitled%203.png" srcset="/img/loading.gif" alt="exploiting-driver/Untitled%203.png"></p>
<p><code>DeviceName</code>이 인스턴스화 되고 <code>DriverObject</code>가 전달되는 것을 볼 수 있으므로 올바른 함수에 도달했음을 알 수 있고 디컴파일을 진행했다.</p>
<p><img src="/2021/04/21/l0ch/exploiting-driver/Untitled%204.png" srcset="/img/loading.gif" alt="exploiting-driver/Untitled%204.png"></p>
<p><code>MajorFunction[14] (offset 0x0e)</code>을 살펴보면 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-device-control">IRP_MJ_DEVICE_CONTROL</a> 드라이버를 찾을 수 있다. 이는 시스템 정의 IOCTL 세트가 있는 경우 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch">DispatchDeviceControl</a> 루틴에서 드라이버가 지원해야 하는 요청이다. <code>SUB_2C580</code>을 디컴파일하면 이 드라이버에 대한 IOCTL 코드에 도달할 수 있다. 아래의 디컴파일 코드를 보고 직접 IOCTL 코드를 찾아보자.</p>
<pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">sub_2C580</span><span class="hljs-params">(__int64 a1, IRP *a2)</span></span>
<span class="hljs-function"></span>&#123;
  BOOLEAN v3; <span class="hljs-comment">// [rsp+20h] [rbp-38h]</span>
  ULONG v4; <span class="hljs-comment">// [rsp+24h] [rbp-34h]</span>
  _IO_STACK_LOCATION *v5; <span class="hljs-comment">// [rsp+28h] [rbp-30h]</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v6; <span class="hljs-comment">// [rsp+30h] [rbp-28h]</span>
  PNAMED_PIPE_CREATE_PARAMETERS v7; <span class="hljs-comment">// [rsp+38h] [rbp-20h]</span>
  a2-&gt;IoStatus.Information = <span class="hljs-number">0</span>i64;
  v5 = a2-&gt;Tail.Overlay.CurrentStackLocation;
  <span class="hljs-keyword">if</span> ( v5-&gt;Parameters.Read.ByteOffset.LowPart == <span class="hljs-number">2252803</span> )
  &#123;
    v4 = v5-&gt;Parameters.Create.Options;
    v7 = v5-&gt;Parameters.CreatePipe.Parameters;
    v3 = IoIs32bitProcess(a2);
    v6 = sub_166D0(v3, v7, v4);
  &#125;
  <span class="hljs-keyword">else</span>
  &#123;
    v6 = <span class="hljs-number">-1073741808</span>;
  &#125;
  a2-&gt;IoStatus.Status = v6;
  IofCompleteRequest(a2, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> v6;
&#125;</code></pre>

<p>찾을 수 없거나 분석이 추가된 코드를 원한다면 다음 코드를 살펴보자.</p>
<pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">Driver_IRP_MJ_DEVICE_CONTROL</span><span class="hljs-params">(DEVICE_OBJECT *DeviceObject, IRP *Irp)</span></span>
<span class="hljs-function"></span>&#123;
  __int64 result; <span class="hljs-comment">// rax</span>
  _BYTE Is32BitProcess; <span class="hljs-comment">// [rsp+20h] [rbp-38h]</span>
  _DWORD bufferSize; <span class="hljs-comment">// [rsp+24h] [rbp-34h]</span>
  _QWORD IoStackLocation; <span class="hljs-comment">// [rsp+28h] [rbp-30h]</span>
  NTSTATUS status; <span class="hljs-comment">// [rsp+30h] [rbp-28h]</span>
  _QWORD userBuffer; <span class="hljs-comment">// [rsp+38h] [rbp-20h]</span>
  _QWORD; <span class="hljs-comment">// [rsp+68h] [rbp+10h]</span>
  Irp-&gt;IoStatus.Information = <span class="hljs-number">0</span>i64;
  IoStackLocation = Irp-&gt;Tail.Overlay.CurrentStackLocation;
  <span class="hljs-keyword">if</span> ( IoStackLocation-&gt;Parameters.Read.ByteOffset.LowPart == <span class="hljs-number">0x226003</span> )<span class="hljs-comment">// IOCTL Code</span>
  &#123;
    bufferSize = IoStackLocation-&gt;Parameters.Create.Options;
    userBuffer = &amp;IoStackLocation-&gt;Parameters.CreatePipe.Parameters-&gt;NamedPipeType;
    Is32BitProcess = IoIs32bitProcess(Irp);
    status = DriverVulnerableFunction(Is32BitProcess, userBuffer, bufferSize);
  &#125;
  <span class="hljs-keyword">else</span>
  &#123;
    status = <span class="hljs-number">0xC0000010</span>;                        <span class="hljs-comment">// STATUS_INVALID_DEVICE_REQUEST</span>
  &#125;
  Irp-&gt;IoStatus.Status = status;
  IofCompleteRequest(Irp, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)status;
&#125;</code></pre>

<p>IOCTL 코드 <code>0x226003</code>는 IOCTL 요청과 함께 전달된 데이터 버퍼에 액세스할 때 커널이 사용하는 방법을 이해하기 위해 추가로 디코딩될 수 있다. <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.osronline.com/article.cfm%5Earticle=229.htm">OSR 온라인 IOCTL 디코더</a> 툴을 사용하여 다음 정보를 복구할 수 있다.</p>
<p><img src="/2021/04/21/l0ch/exploiting-driver/Untitled%205.png" srcset="/img/loading.gif" alt="exploiting-driver/Untitled%205.png"></p>
<p><code>METHOD_NEITHER</code>는 IOCTL 요청과 함께 전달된 데이터 버퍼에 액세스하는 데 사용되는 가장 취약한 방식이다. 이를 사용할 때 I/O 관리자는 유저 데이터에 대해 어떤 종류의 유효성 검사도 수행하지 않고 원시 데이터를 드라이버에 그대로 전달한다. 유효성 검사 없이 유저 데이터를 관리하는 코드에 있는 버그 또는 취약점을 발견할 확률이 더 높다. 이제 IOCTL 코드 <code>0x226003</code>와 장치 이름 <code>\Device\AMP</code>을 구했으니 드라이버를 퍼징하고 취약점을 찾을 수 있다.</p>
<h1 id="Fuzzing"><a href="#Fuzzing" class="headerlink" title="Fuzzing"></a>Fuzzing</h1><p>IOCTL 코드를 검색한 후 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/koutto/ioctlbf">ioctlbf</a>로 드라이버를 퍼징했다. Ioctlbf 구문은 이해하기 매우 쉽다. 먼저 장치 이름 <code>-d</code> 를 지정한 다음 퍼징할 IOCTL 코드를 <code>-i</code>로 지정한 뒤 <code>-u</code> 매개 변수를 사용하여 제공된 IOCTL 코드만 퍼징하도록 한다. (드라이버에 IOCTL 코드가 하나만 있다는 것을 이미 알고 있으므로 무차별 대입이 필요 없다.)</p>
<p><img src="/2021/04/21/l0ch/exploiting-driver/Untitled%206.png" srcset="/img/loading.gif" alt="exploiting-driver/Untitled%206.png"></p>
<p>ioctlbf를 실행한 직후 다음 메시지 <code>amp+6c8d</code>와 함께 디버기 머신에서 크래시가 발생했다.</p>
<pre><code class="hljs apache"><span class="hljs-attribute">Access</span> violation - code c<span class="hljs-number">0000005</span> (!!! second chance !!!)
<span class="hljs-attribute">fffff801</span>`<span class="hljs-number">3</span>ae<span class="hljs-number">96</span>c<span class="hljs-number">8</span>d <span class="hljs-number">488</span>b<span class="hljs-number">0</span>e          mov     rcx,qword ptr<span class="hljs-meta"> [rsi]</span>
<span class="hljs-attribute">PROCESS_NAME</span>:  ioctlbf.EXE
<span class="hljs-attribute">READ_ADDRESS</span>:  <span class="hljs-number">0000000000000000</span> 
<span class="hljs-attribute">ERROR_CODE</span>: (NTSTATUS) <span class="hljs-number">0</span>xc<span class="hljs-number">0000005</span> - The instruction at <span class="hljs-number">0</span>x%p referenced memory at <span class="hljs-number">0</span>x%p. The memory could not be %s.
<span class="hljs-attribute">EXCEPTION_CODE_STR</span>:  c<span class="hljs-number">0000005</span>
<span class="hljs-attribute">EXCEPTION_PARAMETER1</span>:  <span class="hljs-number">0000000000000000</span>
<span class="hljs-attribute">EXCEPTION_PARAMETER2</span>:  <span class="hljs-number">0000000000000000</span>
<span class="hljs-attribute">STACK_TEXT</span>:  
<span class="hljs-attribute">ffff9304</span>`c<span class="hljs-number">35</span>c<span class="hljs-number">66</span>e<span class="hljs-number">0</span> ffffe<span class="hljs-number">60</span>b`ecd<span class="hljs-number">87</span>bb<span class="hljs-number">0</span>     : <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> fffff<span class="hljs-number">801</span>`<span class="hljs-number">35</span>c<span class="hljs-number">23</span>f<span class="hljs-number">8</span>b ffff<span class="hljs-number">9304</span>`c<span class="hljs-number">35</span>c<span class="hljs-number">6700</span> : amp+<span class="hljs-number">0</span>x<span class="hljs-number">6</span>c<span class="hljs-number">8</span>d
<span class="hljs-attribute">ffff9304</span>`c<span class="hljs-number">35</span>c<span class="hljs-number">66</span>e<span class="hljs-number">8</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span>     : <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> fffff<span class="hljs-number">801</span>`<span class="hljs-number">35</span>c<span class="hljs-number">23</span>f<span class="hljs-number">8</span>b ffff<span class="hljs-number">9304</span>`c<span class="hljs-number">35</span>c<span class="hljs-number">6700</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> : <span class="hljs-number">0</span>xffffe<span class="hljs-number">60</span>b`ecd<span class="hljs-number">87</span>bb<span class="hljs-number">0</span>
<span class="hljs-attribute">ffff9304</span>`c<span class="hljs-number">35</span>c<span class="hljs-number">66</span>f<span class="hljs-number">0</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>     : fffff<span class="hljs-number">801</span>`<span class="hljs-number">35</span>c<span class="hljs-number">23</span>f<span class="hljs-number">8</span>b ffff<span class="hljs-number">9304</span>`c<span class="hljs-number">35</span>c<span class="hljs-number">6700</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> ffffe<span class="hljs-number">60</span>b`e<span class="hljs-number">5303</span>c<span class="hljs-number">80</span> : <span class="hljs-number">0</span>x<span class="hljs-number">1</span></code></pre>

<p>널 포인터 역 참조와 유사한 오류이다. 이제 드라이버를 리버스 엔지니어링해 access violation이 발생한 이유와 이를 악용할 수 있는 방법이 있는지 이해하기로 했다.</p>
<hr>
<p>다음 파트는 취약점의 root cause 분석과 익스플로잇에 대한 번역으로 돌아오겠습니다!</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                <div class="post-meta mr-3">
                  <i class="iconfont icon-category"></i>
                  
                  <a class="hover-with-bg" href="/categories/Translation/">Translation</a>
                  
                </div>
                
                
                <div class="post-meta">
                  <i class="iconfont icon-tags"></i>
                  
                  <a class="hover-with-bg" href="/tags/windows/">windows</a>
                  
                  <a class="hover-with-bg" href="/tags/kernel/">kernel</a>
                  
                  <a class="hover-with-bg" href="/tags/ioctl/">ioctl</a>
                  
                  <a class="hover-with-bg" href="/tags/L0ch/">L0ch</a>
                  
                  <a class="hover-with-bg" href="/tags/driver/">driver</a>
                  
                  <a class="hover-with-bg" href="/tags/exploit/">exploit</a>
                  
                </div>
                
              </div>

              <div class="post-metas mb-3">
                <a class="hover-with-bg" style="display: flex;" href="/author">
                  <div class="link-avatar-page">
                    <img src="/img/profile_L0ch.jpg" srcset="/img/loading.gif" alt="L0ch">
                  </div>

                  <div class="link-text">
                    <div class="link-title">L0ch</div>
                  </div>
                </a>
                <div class="link-text">
                  <div class="link-more">
                    <a href="/tags/L0ch">
                      Read more
                      <i class="iconfont icon-arrowdown"></i>
                    </a>
                  </div>
                </div>
              </div>

              <hr>

              <script data-ad-client="ca-pub-3672652207808168" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
              
              
              <div class="post-prevnext row">
                <article class="post-prev col-6">
                  
                  
                  <a href="/2021/04/21/fabu1ous/2021-04-21/">
                    <i class="iconfont icon-arrowleft"></i>
                    <span class="hidden-mobile">[하루한줄] CVE-2020-36167: OpenSSL Backup Exec Service 권한상승</span>
                    <span class="visible-mobile">Previous</span>
                  </a>
                  
                </article>
                <article class="post-next col-6">
                  
                  
                  <a href="/2021/04/20/l0ch/2021-04-20/">
                    <span class="hidden-mobile">[하루한줄] CVE-2011-2523: 현재진행형인 10년 전 vsftpd 백도어 취약점</span>
                    <span class="visible-mobile">Next</span>
                    <i class="iconfont icon-arrowright"></i>
                  </a>
                  
                </article>
              </div>
              
            </div>

            
            <!-- Comments -->
            <article class="comments" id="comments">
              
              
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'https://hackyboiz.github.io/2021/04/21/l0ch/exploiting-driver/';
        this.page.identifier = '/2021/04/21/l0ch/exploiting-driver/';
      };
      function loadDisqus() {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = '//' + 'hackyboiz' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        })();
      }
      waitElementVisible('disqus_thread', loadDisqus);
    </script>
    <noscript>Please enable JavaScript to view the
      <a target="_blank" href="https://disqus.com/?ref_noscript" rel="external nofollow noopener noreferrer">comments powered by Disqus.</a>
    </noscript>
  </div>


            </article>
            
          </article>
        </div>
      </div>
    </div>
    
    <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
      <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

    </div>
    
  </div>
</div>

<!-- Custom -->

    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="external nofollow noopener noreferrer"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="external nofollow noopener noreferrer">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="/js/debouncer.js"></script>
<script src="/js/main.js"></script>

<!-- Plugins -->


  
    <script src="/js/lazyload.js"></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script>
  <script src="/js/clipboard-use.js"></script>







  <script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "[Translation] Exploiting System Mechanic Driver Part 1&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css">

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>

















  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-177243668-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
  

  
    <!-- Google gtag.js -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177243668-2"></script>
    <script defer>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-177243668-2');
    </script>
  

  

  

  





</body>
</html>
